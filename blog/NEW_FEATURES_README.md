# Новый функционал проекта "Афиша города"

## Обзор реализованных улучшений

В рамках ветки `pagination_and_other` были реализованы следующие улучшения:

### 1. Пагинация (постраничный вывод)

**Реализовано:**
- ✅ Пагинация для списка новостей (`NewsListView`) - 8 новостей на страницу
- ✅ Пагинация для списка событий (`EventsView`) - 10 событий на страницу
- ✅ Пагинация для архива событий (`ArchiveView`) - 10 событий на страницу
- ✅ Пагинация для списка коллективов (`EnsembleListView`) - 10 коллективов на страницу

**Файлы:**
- `postapp/views.py` - обновлены views с пагинацией
- `postapp/templates/postapp/news_list.html` - шаблон с пагинацией

### 2. Шаблонные фильтры

**Создано:**
- ✅ `format_price` - форматирование цен (1000 руб → 1 000 ₽)
- ✅ `format_date_range` - форматирование диапазонов дат
- ✅ `truncate_words_smart` - умное обрезание текста по предложениям
- ✅ `highlight_search` - подсветка поисковых терминов
- ✅ `get_category_color` - цвета для категорий событий
- ✅ `get_news_category_color` - цвета для категорий новостей

**Файлы:**
- `postapp/templatetags/postapp_extras.py` - кастомные фильтры

### 3. Менеджеры моделей

**EventManager:**
- ✅ `upcoming()` - предстоящие события
- ✅ `past()` - прошедшие события
- ✅ `today()` - события на сегодня
- ✅ `this_week()` - события на текущую неделю
- ✅ `by_category()` - события по категории
- ✅ `by_venue()` - события по площадке
- ✅ `by_ensemble()` - события по коллективу
- ✅ `search()` - поиск по названию и описанию

**NewsManager:**
- ✅ `published()` - только опубликованные новости
- ✅ `by_category()` - новости по категории
- ✅ `recent()` - последние новости
- ✅ `search()` - поиск по заголовку и содержанию
- ✅ `by_author()` - новости по автору

**Файлы:**
- `postapp/models.py` - добавлены менеджеры и свойства

### 4. Сигналы Django

**Реализовано:**
- ✅ `post_save` для Event - логирование и очистка кеша
- ✅ `post_save` для News - логирование и очистка кеша
- ✅ `post_delete` для Event и News - очистка кеша
- ✅ `pre_save` для Event - проверка изменений даты
- ✅ `pre_save` для News - автоматическое создание excerpt и установка даты публикации

**Файлы:**
- `postapp/signals.py` - сигналы
- `postapp/apps.py` - подключение сигналов

### 5. Контекстные процессоры

**Создано:**
- ✅ `site_stats` - статистика сайта (количество событий, новостей, площадок и т.д.)
- ✅ `navigation_data` - данные для навигации (категории, популярные площадки и коллективы)
- ✅ `user_context` - данные пользователя (количество созданных событий и новостей)
- ✅ `current_time` - текущее время и дата

**Файлы:**
- `postapp/context_processors.py` - контекстные процессоры
- `blog/settings.py` - подключение процессоров

### 6. Новостная система

**Реализовано:**
- ✅ Модель `News` с категориями, авторами, статусом публикации
- ✅ `NewsListView` с пагинацией и фильтрацией
- ✅ `NewsDetailView` для просмотра отдельной новости
- ✅ Админка для управления новостями
- ✅ Команда `generate_news` для создания тестовых новостей

**Файлы:**
- `postapp/models.py` - модель News
- `postapp/views.py` - NewsListView и NewsDetailView
- `postapp/admin.py` - настройки админки
- `postapp/urls.py` - URL для новостей
- `postapp/templates/postapp/news_list.html` - шаблон списка новостей
- `postapp/templates/postapp/news_detail.html` - шаблон детальной страницы новости
- `postapp/management/commands/generate_news.py` - команда генерации новостей

### 7. Свойства моделей

**Event:**
- ✅ `is_upcoming` - является ли событие предстоящим
- ✅ `is_today` - происходит ли событие сегодня
- ✅ `is_past` - является ли событие прошедшим

**News:**
- ✅ `reading_time` - примерное время чтения новости

### 8. Тестирование

**Создано:**
- ✅ `ModelManagersTest` - тесты менеджеров моделей
- ✅ `TemplateFiltersTest` - тесты шаблонных фильтров
- ✅ `ModelPropertiesTest` - тесты свойств моделей
- ✅ `ContextProcessorsTest` - тесты контекстных процессоров
- ✅ `NewsListViewTest` - тесты views новостей
- ✅ `SignalsTest` - тесты сигналов

**Файлы:**
- `postapp/test_new_features.py` - тесты нового функционала

## Как использовать новый функционал

### Пагинация
Пагинация работает автоматически во всех списках. Навигация по страницам доступна внизу страницы.

### Шаблонные фильтры
```django
{% load postapp_extras %}

<!-- Форматирование цены -->
{{ event.price|format_price }}

<!-- Форматирование дат -->
{{ start_date|format_date_range:end_date }}

<!-- Умное обрезание текста -->
{{ news.content|truncate_words_smart:30 }}

<!-- Цвета категорий -->
<span class="badge bg-{{ event.category|get_category_color }}">
    {{ event.get_category_display }}
</span>
```

### Менеджеры моделей
```python
# Получить предстоящие события
upcoming_events = Event.objects.upcoming()

# Получить события на сегодня
today_events = Event.objects.today()

# Поиск событий
search_results = Event.objects.search('концерт')

# Получить опубликованные новости
published_news = News.objects.published()

# Поиск новостей
news_results = News.objects.search('фестиваль')
```

### Контекстные процессоры
Контекстные процессоры автоматически добавляют данные во все шаблоны:

```django
<!-- Статистика сайта -->
{{ site_stats.total_events }} событий
{{ site_stats.total_news }} новостей

<!-- Данные пользователя -->
{% if user.is_authenticated %}
    {{ user_events_count }} созданных событий
    {{ user_news_count }} созданных новостей
{% endif %}

<!-- Текущее время -->
{{ current_time }}
```

### Создание тестовых новостей
```bash
python manage.py generate_news --count 20
```

## Запуск тестов

```bash
# Запуск всех тестов нового функционала
python manage.py test postapp.test_new_features

# Запуск с подробным выводом
python manage.py test postapp.test_new_features -v 2
```

## Кеширование

Система использует кеширование для:
- Статистики сайта (10 минут)
- Данных навигации (30 минут)
- Списков событий и новостей (очищается при изменениях)

## Логирование

Сигналы автоматически логируют:
- Создание и обновление событий
- Создание и обновление новостей
- Удаление событий и новостей
- Изменения дат событий

## Производительность

- Пагинация снижает нагрузку на базу данных
- Кеширование уменьшает количество запросов
- Менеджеры моделей оптимизируют запросы
- Контекстные процессоры кешируют часто используемые данные

## Безопасность

- Проверка аутентификации в контекстных процессорах
- Фильтрация по статусу публикации новостей
- Валидация данных в сигналах
- Защита от SQL-инъекций в менеджерах

## Расширяемость

Система легко расширяется:
- Добавление новых категорий событий и новостей
- Создание новых шаблонных фильтров
- Добавление новых менеджеров моделей
- Создание дополнительных контекстных процессоров 